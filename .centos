#!/bin/bash

#check permission
if [ $(id -u) != '0' ]; then
	echo 'Error: You must be root to run this script'
	exit 1
fi

#config
epel_url='http://mirrors.sohu.com/fedora-epel/6Server/x86_64/epel-release-6-8.noarch.rpm'
cur_dir=${pwd}
node_ver='0.10.26'
pcre_ver='8.35'
nginx_ver='1.6.0'
nginx_user='www'

#installer
function installer(){
	wget -c $3
	tar zxvf $2
	cd $1
	./configure $4
	make && make install
	cd ..
}

#back to root directory
cd

echo '================== add repo & install tools && update && upgrade ==================';
rpm -ivh ${epel_url}
yum repolist
yum install -y ntp vim* make cmake gcc gcc-c++ wget curl curl-devel openssl openssl-devel telnet* golang git-core subversion mysql-server php php-fpm php-mysql php-mcrypt php-gd php-mbstring php-xml php-imap
yum update -y
yum upgrade -y

echo '================== chkconfig ==================';
sed -i "s/user = apache/user = ${nginx_user}/g" /etc/php-fpm.d/www.conf
sed -i "s/group = apache/group = ${nginx_user}/g" /etc/php-fpm.d/www.conf
chgrp ${nginx_user} /var/lib/php/session
chkconfig --level 235 php-fpm on
service php-fpm start
chkconfig --level 235 mysqld on
service mysqld start
#grant all privileges on *.* to user@'host' identified by 'password';
#flush privileges;

echo '================== nodejs ==================';
name="node-v${node_ver}"
tar="${name}.tar.gz"
installer ${name} ${tar} "http://nodejs.org/dist/v${node_ver}/${tar}"

echo '================== grunt-cli ==================';
npm install -g grunt-cli

echo '================== pcre ==================';
name="pcre-${pcre_ver}"
tar="${name}.tar.gz"
installer ${name} ${tar} "ftp://ftp.csx.cam.ac.uk/pub/software/programming/pcre/${tar}"

echo '================== nginx ==================';
useradd -s /sbin/nologin ${nginx_user}
chmod 755 /home/${nginx_user}
name="nginx-${nginx_ver}"
tar="${name}.tar.gz"
installer ${name} ${tar} "http://nginx.org/download/${tar}" " --user=www --group=www --with-http_stub_status_module --with-http_ssl_module --with-http_gzip_static_module --with-ipv6"
ln -s /lib64/libpcre.so.0.0.1 /lib64/libpcre.so.1